<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COMPASS - Process Interview System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a1628 0%, #1a2744 100%);
            min-height: 100vh;
            padding: 20px;
            color: #f8f6f0;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 30px 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(201, 162, 39, 0.3);
        }
        
        .header h1 {
            font-size: 2.5rem;
            color: #c9a227;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1rem;
            color: rgba(248, 246, 240, 0.8);
        }
        
        .badge {
            display: inline-block;
            background: linear-gradient(135deg, #c9a227, #d4af37);
            color: #0a1628;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: bold;
            margin-top: 10px;
        }
        
        .stage-selector {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stage-card {
            background: rgba(255, 255, 255, 0.03);
            border: 2px solid rgba(201, 162, 39, 0.3);
            border-radius: 12px;
            padding: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .stage-card:hover {
            background: rgba(201, 162, 39, 0.1);
            border-color: #c9a227;
            transform: translateY(-5px);
        }
        
        .stage-card.selected {
            background: rgba(201, 162, 39, 0.2);
            border-color: #c9a227;
            box-shadow: 0 4px 12px rgba(201, 162, 39, 0.4);
        }
        
        .stage-card h2 {
            color: #c9a227;
            font-size: 2rem;
            margin-bottom: 15px;
        }
        
        .stage-card p {
            color: rgba(248, 246, 240, 0.8);
            line-height: 1.6;
        }
        
        .upload-section {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
            border: 2px dashed rgba(201, 162, 39, 0.3);
            text-align: center;
        }
        
        .upload-section h3 {
            color: #c9a227;
            margin-bottom: 15px;
        }
        
        .upload-btn {
            display: inline-block;
            padding: 15px 30px;
            background: linear-gradient(135deg, #c9a227, #d4af37);
            color: #0a1628;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(201, 162, 39, 0.4);
        }
        
        .process-selector {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
            border: 1px solid rgba(201, 162, 39, 0.2);
        }
        
        .process-selector h3 {
            color: #c9a227;
            margin-bottom: 20px;
        }
        
        .process-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .process-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 8px;
            border: 2px solid rgba(201, 162, 39, 0.2);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .process-item:hover {
            background: rgba(201, 162, 39, 0.1);
            border-color: #c9a227;
        }
        
        .process-item.selected {
            background: rgba(201, 162, 39, 0.2);
            border-color: #c9a227;
        }
        
        .process-item h4 {
            color: #c9a227;
            margin-bottom: 10px;
        }
        
        .process-item p {
            color: rgba(248, 246, 240, 0.7);
            font-size: 0.9rem;
        }
        
        .progress-bar {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(201, 162, 39, 0.2);
        }
        
        .progress-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 0.9rem;
        }
        
        .progress-track {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #c9a227, #d4af37);
            width: 0%;
            transition: width 0.5s ease;
        }
        
        .job-header {
            background: rgba(201, 162, 39, 0.1);
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #c9a227;
        }
        
        .job-header h3 {
            color: #c9a227;
            margin-bottom: 5px;
        }
        
        .job-header p {
            color: rgba(248, 246, 240, 0.7);
            font-size: 0.9rem;
        }
        
        .chat-container {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(201, 162, 39, 0.2);
            min-height: 400px;
            max-height: 600px;
            overflow-y: auto;
        }
        
        .message {
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 8px;
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .message.compass {
            background: rgba(201, 162, 39, 0.1);
            border-left: 4px solid #c9a227;
        }
        
        .message.user {
            background: rgba(100, 149, 237, 0.1);
            border-left: 4px solid #6495ed;
        }
        
        .message.system {
            background: rgba(76, 175, 80, 0.1);
            border-left: 4px solid #4caf50;
            font-style: italic;
        }
        
        .message-label {
            font-weight: bold;
            font-size: 0.9rem;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .message.compass .message-label {
            color: #c9a227;
        }
        
        .message.user .message-label {
            color: #6495ed;
        }
        
        .message.system .message-label {
            color: #4caf50;
        }
        
        .message-content {
            line-height: 1.6;
            white-space: pre-wrap;
        }
        
        .input-area {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        #userInput {
            flex: 1;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid rgba(201, 162, 39, 0.3);
            background: rgba(255, 255, 255, 0.05);
            color: #f8f6f0;
            font-size: 1rem;
            font-family: inherit;
        }
        
        #userInput:focus {
            outline: none;
            border-color: #c9a227;
        }
        
        button {
            padding: 15px 30px;
            border-radius: 8px;
            border: none;
            background: linear-gradient(135deg, #c9a227, #d4af37);
            color: #0a1628;
            font-weight: bold;
            font-size: 1rem;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(201, 162, 39, 0.4);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .status {
            text-align: center;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-weight: bold;
        }
        
        .status.ready {
            background: rgba(76, 175, 80, 0.2);
            color: #76ff7a;
        }
        
        .status.thinking {
            background: rgba(255, 193, 7, 0.2);
            color: #ffd54f;
        }
        
        .status.validating {
            background: rgba(156, 39, 176, 0.2);
            color: #ce93d8;
        }
        
        .validation-panel {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid rgba(201, 162, 39, 0.2);
        }
        
        .validation-panel h3 {
            color: #c9a227;
            margin-bottom: 15px;
        }
        
        .library-panel {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid rgba(201, 162, 39, 0.2);
        }
        
        .library-panel h3 {
            color: #c9a227;
            margin-bottom: 15px;
        }
        
        .library-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        
        .stat-card {
            background: rgba(201, 162, 39, 0.1);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #c9a227;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: rgba(248, 246, 240, 0.7);
        }
        
        .export-btn {
            width: 100%;
            margin-top: 10px;
        }
        
        .hidden {
            display: none;
        }
        
        input[type="file"] {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>COMPASSâ„¢</h1>
            <p>Critical Operations Mapping and Process Analysis System</p>
            <div class="badge">UNIVERSAL PROCESS GRAMMAR</div>
        </div>
        
        <!-- Stage Selection -->
        <div id="stageSelection" class="stage-selector">
            <div class="stage-card" onclick="selectStage(1)">
                <h2>Stage 1</h2>
                <p>Process Interview</p>
                <p style="margin-top: 10px; font-size: 0.85rem;">Discover Milestones, Jobs, and high-level structure</p>
            </div>
            <div class="stage-card" onclick="selectStage(2)">
                <h2>Stage 2</h2>
                <p>Task Interview</p>
                <p style="margin-top: 10px; font-size: 0.85rem;">Extract Tasks, Steps, and Action-Object libraries</p>
            </div>
        </div>
        
        <!-- Stage 2: Upload & Process Selection -->
        <div id="stage2Upload" class="upload-section hidden">
            <h3>Load Stage 1 Results</h3>
            <p style="margin-bottom: 20px; color: rgba(248, 246, 240, 0.7);">
                Upload your Stage 1 JSON to continue
            </p>
            <label for="stage1Upload" class="upload-btn">
                Choose Stage 1 File
            </label>
            <input type="file" id="stage1Upload" accept=".json" onchange="loadStage1()">
            <div id="uploadStatus" style="margin-top: 15px; color: #76ff7a;"></div>
        </div>
        
        <div id="processSelection" class="process-selector hidden">
            <h3>Select Process to Interview</h3>
            <div id="processList" class="process-list"></div>
            <button onclick="startSelectedProcess()" style="margin-top: 20px; width: 100%;">
                Begin Task Interviews
            </button>
        </div>
        
        <!-- Progress Bar (Stage 2 only) -->
        <div id="progressSection" class="progress-bar hidden">
            <div class="progress-info">
                <span>Progress: <span id="progressText">0/0 Jobs</span></span>
                <span id="libraryText">Libraries: 0 Actions, 0 Objects</span>
            </div>
            <div class="progress-track">
                <div id="progressFill" class="progress-fill"></div>
            </div>
        </div>
        
        <!-- Current Job Header (Stage 2 only) -->
        <div id="jobHeader" class="job-header hidden">
            <h3 id="currentJobName">Job Name</h3>
            <p id="currentMilestone">Milestone Name</p>
        </div>
        
        <!-- Status -->
        <div id="status" class="status hidden">Ready</div>
        
        <!-- Chat Container -->
        <div id="chatContainer" class="chat-container hidden"></div>
        
        <!-- Input Area -->
        <div class="input-area">
            <input 
                type="text" 
                id="userInput" 
                placeholder="Select a stage to begin..."
                disabled
            />
            <button id="sendBtn" onclick="sendMessage()" disabled>Send</button>
            <button id="saveBtn" onclick="manualSave()" disabled class="hidden" style="background: linear-gradient(135deg, #4caf50, #66bb6a);">
                ðŸ’¾ Save
            </button>
            <button id="completeBtn" onclick="completeInterview()" disabled class="hidden">
                Complete
            </button>
        </div>
        
        <div style="text-align: center; margin-top: 10px; font-size: 0.85rem; color: rgba(248, 246, 240, 0.6);" id="saveStatus" class="hidden">
            Auto-save enabled â€¢ Last saved: <span id="lastSaved">Never</span>
        </div>
        
        <!-- Validation Panel (Stage 2) -->
        <div id="validationPanel" class="validation-panel hidden">
            <h3>Validation Results</h3>
            <div id="validationContent"></div>
        </div>
        
        <!-- Library Panel (Stage 2) -->
        <div id="libraryPanel" class="library-panel hidden">
            <h3>Global Library</h3>
            <div class="library-stats">
                <div class="stat-card">
                    <div class="stat-number" id="actionsCount">0</div>
                    <div class="stat-label">Actions</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="objectsCount">0</div>
                    <div class="stat-label">Objects</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="tasksCount">0</div>
                    <div class="stat-label">Tasks</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="stepsCount">0</div>
                    <div class="stat-label">Steps</div>
                </div>
            </div>
            <button class="export-btn" onclick="exportResults()">
                Download Results (JSON)
            </button>
        </div>
    </div>
    
    <script>
        // Global state
        let apiKey = '';
        let selectedStage = 0;
        let stage1Data = null;
        let selectedProcess = null;
        let conversationHistory = [];
        let completedJobs = [];
        let globalLibrary = { actions: [], objects: [] };
        let currentMilestoneIndex = 0;
        let currentJobIndex = 0;
        
        // Save state to localStorage
        function saveState() {
            try {
                const state = {
                    selectedStage,
                    stage1Data,
                    selectedProcess,
                    conversationHistory,
                    completedJobs,
                    globalLibrary,
                    currentMilestoneIndex,
                    currentJobIndex,
                    timestamp: new Date().toISOString()
                };
                localStorage.setItem('compass_interview_state', JSON.stringify(state));
                console.log('State saved:', new Date().toLocaleTimeString());
                return true;
            } catch (error) {
                console.error('Error saving state:', error);
                return false;
            }
        }
        
        // Load state from localStorage
        function loadState() {
            try {
                const saved = localStorage.getItem('compass_interview_state');
                if (!saved) return null;
                
                const state = JSON.parse(saved);
                return state;
            } catch (error) {
                console.error('Error loading state:', error);
                return null;
            }
        }
        
        // Clear saved state
        function clearSavedState() {
            localStorage.removeItem('compass_interview_state');
            console.log('Saved state cleared');
        }
        
        // Restore state
        function restoreState(state) {
            selectedStage = state.selectedStage;
            stage1Data = state.stage1Data;
            selectedProcess = state.selectedProcess;
            conversationHistory = state.conversationHistory;
            completedJobs = state.completedJobs;
            globalLibrary = state.globalLibrary;
            currentMilestoneIndex = state.currentMilestoneIndex;
            currentJobIndex = state.currentJobIndex;
            
            // Rebuild UI based on stage
            if (selectedStage === 1) {
                restoreStage1UI();
            } else if (selectedStage === 2) {
                restoreStage2UI();
            }
        }
        
        function restoreStage1UI() {
            document.getElementById('stageSelection').style.display = 'none';
            document.getElementById('status').classList.remove('hidden');
            document.getElementById('chatContainer').classList.remove('hidden');
            
            // Restore conversation
            document.getElementById('chatContainer').innerHTML = '';
            conversationHistory.forEach(msg => {
                if (msg.role === 'assistant') {
                    addMessage('compass', msg.content);
                } else if (msg.role === 'user' && msg.content !== 'START_INTERVIEW') {
                    addMessage('user', msg.content);
                }
            });
            
            enableInput();
            updateStatus('Resumed - Continue interview', 'ready');
        }
        
        function restoreStage2UI() {
            document.getElementById('stageSelection').style.display = 'none';
            document.getElementById('progressSection').classList.remove('hidden');
            document.getElementById('jobHeader').classList.remove('hidden');
            document.getElementById('status').classList.remove('hidden');
            document.getElementById('chatContainer').classList.remove('hidden');
            document.getElementById('libraryPanel').classList.remove('hidden');
            
            // Update progress
            updateProgress();
            
            // Show current job
            const jobInfo = getCurrentJob();
            if (jobInfo) {
                document.getElementById('currentJobName').textContent = jobInfo.job;
                document.getElementById('currentMilestone').textContent = `Milestone: ${jobInfo.milestone}`;
            }
            
            // Restore conversation
            document.getElementById('chatContainer').innerHTML = '';
            conversationHistory.forEach(msg => {
                if (msg.role === 'assistant') {
                    addMessage('compass', msg.content);
                } else if (msg.role === 'user') {
                    addMessage('user', msg.content);
                }
            });
            
            // Update library stats
            updateLibraryDisplay();
            
            enableInput();
            document.getElementById('completeBtn').classList.remove('hidden');
            updateStatus('Resumed - Continue interview', 'ready');
        }
        
        // Auto-save after each message
        function autoSave() {
            if (selectedStage > 0) {
                if (saveState()) {
                    const now = new Date().toLocaleTimeString();
                    document.getElementById('lastSaved').textContent = now;
                }
            }
        }
        
        // Manual save function
        function manualSave() {
            if (saveState()) {
                const now = new Date().toLocaleTimeString();
                document.getElementById('lastSaved').textContent = now;
                addMessage('system', 'âœ“ Progress saved. You can close the browser and resume later.');
            } else {
                addMessage('system', 'âœ— Save failed. Check console for details.');
            }
        }
        
        // Warn before closing with unsaved work
        window.addEventListener('beforeunload', function(e) {
            if (conversationHistory.length > 0 && selectedStage > 0) {
                saveState(); // Auto-save on close
                e.preventDefault();
                e.returnValue = 'Interview in progress. Progress has been auto-saved.';
            }
        });
        
        // Initialize
        window.onload = function() {
            // Check for saved state
            const savedState = loadState();
            
            if (savedState) {
                const savedTime = new Date(savedState.timestamp).toLocaleString();
                const resume = confirm(`Found saved interview from ${savedTime}.\n\nResume where you left off?`);
                
                if (resume) {
                    const key = prompt('Enter your Anthropic API key:');
                    if (key) {
                        apiKey = key;
                        restoreState(savedState);
                        addMessage('system', `âœ“ Interview resumed from ${savedTime}`);
                        return;
                    }
                } else {
                    clearSavedState();
                }
            }
            
            // Normal startup - get API key
            const key = prompt('Enter your Anthropic API key:');
            if (key) {
                apiKey = key;
            } else {
                document.getElementById('userInput').placeholder = 'API key required';
            }
        };
        
        function selectStage(stage) {
            selectedStage = stage;
            
            // Update UI
            document.querySelectorAll('.stage-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.target.closest('.stage-card').classList.add('selected');
            
            if (stage === 1) {
                // Stage 1: Start immediately
                startStage1();
            } else {
                // Stage 2: Show upload
                document.getElementById('stage2Upload').classList.remove('hidden');
            }
        }
        
        async function startStage1() {
            // Hide stage selection
            document.getElementById('stageSelection').style.display = 'none';
            
            // Show interview UI
            document.getElementById('status').classList.remove('hidden');
            document.getElementById('chatContainer').classList.remove('hidden');
            document.getElementById('status').textContent = 'Ready to begin Stage 1 interview';
            document.getElementById('status').className = 'status ready';
            
            // Start interview
            updateStatus('COMPASS is preparing...', 'thinking');
            const opening = await callStage1Agent('START_INTERVIEW');
            
            if (opening) {
                addMessage('compass', opening);
                enableInput();
                updateStatus('Interview in progress', 'ready');
            }
        }
        
        function loadStage1() {
            const fileInput = document.getElementById('stage1Upload');
            const file = fileInput.files[0];
            
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    stage1Data = JSON.parse(e.target.result);
                    document.getElementById('uploadStatus').textContent = `âœ“ Loaded: ${stage1Data.processName}`;
                    
                    // Hide upload, show process selection
                    document.getElementById('stage2Upload').style.display = 'none';
                    showProcessSelection();
                    
                } catch (error) {
                    document.getElementById('uploadStatus').textContent = 'âœ— Error: Invalid JSON file';
                    document.getElementById('uploadStatus').style.color = '#f44336';
                }
            };
            reader.readAsText(file);
        }
        
        function showProcessSelection() {
            const processList = document.getElementById('processList');
            
            // Create process card
            const processItem = document.createElement('div');
            processItem.className = 'process-item selected';
            processItem.onclick = function() {
                selectedProcess = stage1Data.processName;
                document.querySelectorAll('.process-item').forEach(p => p.classList.remove('selected'));
                this.classList.add('selected');
            };
            
            const totalJobs = stage1Data.structure.milestones.reduce((sum, m) => sum + m.jobs.length, 0);
            
            processItem.innerHTML = `
                <h4>${stage1Data.processName}</h4>
                <p>${stage1Data.structure.milestones.length} Milestones, ${totalJobs} Jobs</p>
                <p style="margin-top: 5px;">Interviewed: ${new Date(stage1Data.interviewDate).toLocaleDateString()}</p>
            `;
            
            processList.appendChild(processItem);
            selectedProcess = stage1Data.processName;
            
            document.getElementById('processSelection').classList.remove('hidden');
        }
        
        async function startSelectedProcess() {
            if (!selectedProcess) return;
            
            // Hide process selection
            document.getElementById('processSelection').style.display = 'none';
            
            // Show Stage 2 UI
            document.getElementById('progressSection').classList.remove('hidden');
            document.getElementById('jobHeader').classList.remove('hidden');
            document.getElementById('status').classList.remove('hidden');
            document.getElementById('chatContainer').classList.remove('hidden');
            document.getElementById('libraryPanel').classList.remove('hidden');
            
            // Start first job
            startCurrentJob();
        }
        
        async function startCurrentJob() {
            const jobInfo = getCurrentJob();
            if (!jobInfo) {
                finishAllJobs();
                return;
            }
            
            document.getElementById('currentJobName').textContent = jobInfo.job;
            document.getElementById('currentMilestone').textContent = `Milestone: ${jobInfo.milestone}`;
            updateProgress();
            
            conversationHistory = [];
            document.getElementById('chatContainer').innerHTML = '';
            
            updateStatus('COMPASS is preparing...', 'thinking');
            
            // Build rich context for Stage 2 opening
            const jobContext = `STAGE 2 TASK INTERVIEW - STARTING NEW JOB

PROCESS: ${stage1Data.processName}
MILESTONE: ${jobInfo.milestone} (${jobInfo.milestoneIndex + 1} of ${stage1Data.structure.milestones.length})
JOB: ${jobInfo.job}

ACTORS AVAILABLE: ${stage1Data.structure.actors ? stage1Data.structure.actors.join(', ') : 'Not specified'}

YOUR TASK:
1. Introduce yourself briefly
2. Confirm the Job name with the SME
3. Ask: "What are the main Tasks you perform within this Job?"
4. For each Task, you will gather: Summary, Actor, Duration, and Steps

Begin the interview now.`;
            
            const opening = await callStage2Agent(jobContext);
            
            if (opening) {
                addMessage('compass', opening);
                enableInput();
                document.getElementById('completeBtn').classList.remove('hidden');
                updateStatus('Interview in progress', 'ready');
            }
        }
        
        function getCurrentJob() {
            if (currentMilestoneIndex >= stage1Data.structure.milestones.length) {
                return null;
            }
            
            const milestone = stage1Data.structure.milestones[currentMilestoneIndex];
            if (currentJobIndex >= milestone.jobs.length) {
                currentMilestoneIndex++;
                currentJobIndex = 0;
                return getCurrentJob();
            }
            
            // FIX: Jobs are stored as strings in Stage 1 output, not objects
            const jobData = milestone.jobs[currentJobIndex];
            const jobName = typeof jobData === 'string' ? jobData : jobData.name;
            
            return {
                job: jobName,
                milestone: milestone.name,
                milestoneIndex: currentMilestoneIndex,
                jobIndex: currentJobIndex,
                processName: stage1Data.processName
            };
        }
        
        async function sendMessage() {
            const input = document.getElementById('userInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            addMessage('user', message);
            input.value = '';
            disableInput();
            updateStatus('COMPASS is thinking...', 'thinking');
            
            const agent = selectedStage === 1 ? callStage1Agent : callStage2Agent;
            const response = await agent(message);
            
            if (response) {
                addMessage('compass', response);
                autoSave(); // Auto-save after each exchange
                enableInput();
                updateStatus('Interview in progress', 'ready');
            }
        }
        
        async function completeInterview() {
            if (selectedStage === 1) {
                // Complete Stage 1
                updateStatus('Extracting structure...', 'validating');
                // Export and finish
                exportResults();
            } else {
                // Complete current Job in Stage 2
                const jobInfo = getCurrentJob();
                
                if (jobInfo) {
                    // Save completed job with transcript
                    updateStatus('Extracting Tasks from conversation...', 'validating');
                    
                    // Call extraction to parse tasks from transcript
                    const extractedTasks = await extractTasksFromTranscript(jobInfo);
                    
                    completedJobs.push({
                        jobName: jobInfo.job,
                        milestone: jobInfo.milestone,
                        completedAt: new Date().toISOString(),
                        transcript: [...conversationHistory],
                        tasks: extractedTasks || []
                    });
                    
                    addMessage('system', `âœ“ Job "${jobInfo.job}" completed. ${extractedTasks ? extractedTasks.length + ' tasks extracted.' : 'Tasks will be extracted on export.'}`);
                }
                
                currentJobIndex++;
                updateProgress();
                startCurrentJob();
            }
        }
        
        async function extractTasksFromTranscript(jobInfo) {
            // Call Claude to extract structured tasks from the conversation
            try {
                const extractionPrompt = `Based on this interview transcript about the Job "${jobInfo.job}", extract all Tasks discussed.

For each Task, provide:
- name: Verb-Noun format (e.g., "Review Application")
- summary: Brief description
- actor: Who performs this task
- estimatedDuration: How long it typically takes
- steps: Array of steps, each with action, object, and optional conditional

Return ONLY valid JSON in this format:
{
  "tasks": [
    {
      "name": "Task Name",
      "summary": "What this task accomplishes",
      "actor": "Role who performs it",
      "estimatedDuration": "X minutes",
      "steps": [
        {"action": "Verb", "object": "Noun", "conditional": "if applicable"}
      ]
    }
  ]
}

TRANSCRIPT:
${conversationHistory.map(m => `${m.role.toUpperCase()}: ${m.content}`).join('\n\n')}`;

                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': apiKey,
                        'anthropic-version': '2023-06-01'
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 3000,
                        messages: [{ role: 'user', content: extractionPrompt }]
                    })
                });
                
                if (!response.ok) return null;
                
                const data = await response.json();
                const text = data.content[0].text;
                
                // Parse JSON from response
                const jsonMatch = text.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    const parsed = JSON.parse(jsonMatch[0]);
                    
                    // Update global libraries with extracted actions/objects
                    if (parsed.tasks) {
                        parsed.tasks.forEach(task => {
                            if (task.steps) {
                                task.steps.forEach(step => {
                                    if (step.action && !globalLibrary.actions.includes(step.action)) {
                                        globalLibrary.actions.push(step.action);
                                    }
                                    if (step.object && !globalLibrary.objects.includes(step.object)) {
                                        globalLibrary.objects.push(step.object);
                                    }
                                });
                            }
                        });
                    }
                    
                    return parsed.tasks;
                }
                return null;
            } catch (error) {
                console.error('Task extraction error:', error);
                return null;
            }
        }
        
        async function callStage1Agent(userMessage) {
            try {
                conversationHistory.push({ role: 'user', content: userMessage });
                
                // Add timeout
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 60000); // 60 second timeout
                
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': apiKey,
                        'anthropic-version': '2023-06-01'
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 1500,
                        system: `You are COMPASS conducting a Stage 1 Process Interview.

YOUR MISSION:
Discover the high-level structure of a business process through natural conversation.

EXTRACT:
- MILESTONES: Major phases (3-8 typically)
- JOBS: Work groupings within each milestone
- ACTORS: Who performs the work
- CONDITIONAL VARIABLES: Decision points that create different paths

INTELLIGENCE PROTOCOLS:

1. REDUNDANCY INVESTIGATION
   If SME describes similar work twice, probe: "I notice X and Y seem similar. Why are both necessary?"
   - Could be multi-authority compliance (keep both)
   - Could be legacy redundancy (flag for consolidation)

2. EXCEPTION DETECTION  
   When you hear "sometimes", "usually", "except when" - probe for the exception handling process.

3. DURATION CAPTURE
   Ask: "About how long does this phase typically take?"

INTERVIEW APPROACH:
1. Start with: "What process would you like to document today?"
2. Ask for big picture walkthrough
3. Confirm major phases (milestones)
4. Dive into each phase for jobs
5. Capture actors and conditional variables
6. Summarize and confirm

Ask ONE question at a time. Be conversational and curious.`,
                        messages: conversationHistory
                    }),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API Error: ${errorData.error?.message || response.statusText}`);
                }
                
                const data = await response.json();
                const assistantResponse = data.content[0].text;
                conversationHistory.push({ role: 'assistant', content: assistantResponse });
                
                return assistantResponse;
                
            } catch (error) {
                console.error('Error calling Stage 1 Agent:', error);
                
                // Show error to user
                let errorMessage = 'API call failed: ';
                if (error.name === 'AbortError') {
                    errorMessage += 'Request timed out. Please try again. Please try again.';
                } else if (error.message.includes('API Error')) {
                    errorMessage += error.message;
                } else {
                    errorMessage += 'Network error. Check console for details.';
                }
                
                addMessage('system', `âŒ ERROR: ${errorMessage}`);
                updateStatus('Error - see message above', 'ready');
                enableInput();
                
                return null;
            }
        }
        
        async function callStage2Agent(userMessage) {
            try {
                conversationHistory.push({ role: 'user', content: userMessage });
                
                // Add timeout
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 90000); // 90 second timeout for Stage 2
                
                // Enhanced Stage 2 System Prompt with full UPG Task requirements
                const stage2SystemPrompt = `You are COMPASS conducting a Stage 2 Task Interview.

YOUR MISSION:
Extract detailed Task information for the current Job. Each Task must include ALL mandatory elements per Universal Process Grammar (UPG).

MANDATORY TASK ELEMENTS:
1. SUMMARY - Brief description of what the task accomplishes
2. ACTOR - Who performs this task (role/title, not person name)
3. EXPECTED DURATION - How long does this typically take? (minutes/hours)
4. STEPS - The sequence of actions within this task

STEP STRUCTURE (Action-Object-Conditional):
Each step must have:
- ACTION: A verb describing what is done (e.g., Review, Enter, Verify, Submit)
- OBJECT: What the action is performed on (e.g., Application, Form, Record)
- CONDITIONAL (optional): Under what circumstances (e.g., "if incomplete", "when approved")

INTERVIEW APPROACH:
1. Ask ONE question at a time
2. For each Task, gather: Summary â†’ Actor â†’ Duration â†’ Steps
3. For Steps, probe: "What's the first thing you do? Then what?"
4. Detect conditionals: "Does this change based on any factors?"
5. Confirm before moving to next Task

EXAMPLE TASK OUTPUT:
Task: "Verify Insurance Status"
- Summary: Check if veteran has existing insurance coverage
- Actor: Intake Coordinator
- Duration: 5-10 minutes
- Steps:
  1. Open [Insurance Database] 
  2. Enter [Veteran SSN]
  3. Review [Coverage Status]
  4. Document [Finding] in case file
  5. Flag [Case] IF no coverage found

Be conversational but thorough. Extract ALL tasks within this Job before signaling completion.`;

                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': apiKey,
                        'anthropic-version': '2023-06-01'
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 2000,
                        system: stage2SystemPrompt,
                        messages: conversationHistory
                    }),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API Error: ${errorData.error?.message || response.statusText}`);
                }
                
                const data = await response.json();
                const assistantResponse = data.content[0].text;
                conversationHistory.push({ role: 'assistant', content: assistantResponse });
                
                return assistantResponse;
                
            } catch (error) {
                console.error('Error calling Stage 2 Agent:', error);
                
                // Show error to user
                let errorMessage = 'API call failed: ';
                if (error.name === 'AbortError') {
                    errorMessage += 'Request timed out. Please try again. Please try again.';
                } else if (error.message.includes('API Error')) {
                    errorMessage += error.message;
                } else {
                    errorMessage += 'Network error. Check console for details.';
                }
                
                addMessage('system', `âŒ ERROR: ${errorMessage}`);
                updateStatus('Error - see message above', 'ready');
                enableInput();
                
                return null;
            }
        }
        
        function updateProgress() {
            if (selectedStage !== 2) return;
            
            const totalJobs = stage1Data.structure.milestones.reduce((sum, m) => sum + m.jobs.length, 0);
            const completed = completedJobs.length;
            const percent = (completed / totalJobs * 100).toFixed(0);
            
            document.getElementById('progressText').textContent = `${completed}/${totalJobs} Jobs`;
            document.getElementById('progressFill').style.width = `${percent}%`;
            document.getElementById('libraryText').textContent = 
                `Libraries: ${globalLibrary.actions.length} Actions, ${globalLibrary.objects.length} Objects`;
        }
        
        function finishAllJobs() {
            addMessage('system', 'ðŸŽ‰ ALL JOBS COMPLETED!\n\nStage 2 Interview is complete. Click the button below to download your results.');
            updateStatus('All jobs completed!', 'ready');
            disableInput();
            
            // Show download button
            document.getElementById('completeBtn').textContent = 'ðŸ“¥ Download Stage 2 Results';
            document.getElementById('completeBtn').classList.remove('hidden');
            document.getElementById('completeBtn').disabled = false;
            document.getElementById('completeBtn').onclick = function() {
                exportResults();
            };
        }
        
        function exportResults() {
            const stageName = selectedStage === 1 ? 'Stage1' : 'Stage2';
            const processName = selectedStage === 1 ? 'Process' : stage1Data.processName;
            
            const output = selectedStage === 1 ? {
                processName: processName,
                interviewDate: new Date().toISOString(),
                stage: 'Stage 1 - Process Interview',
                structure: { milestones: [] },
                transcript: conversationHistory
            } : {
                processName: stage1Data.processName,
                stage1Reference: stage1Data.interviewDate,
                interviewDate: new Date().toISOString(),
                stage: 'Stage 2 - Task Interview',
                actionLibrary: globalLibrary.actions,
                objectLibrary: globalLibrary.objects,
                completedJobs: completedJobs
            };
            
            const blob = new Blob([JSON.stringify(output, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `COMPASS_${processName.replace(/\s+/g, '_')}_${stageName}_${Date.now()}.json`;
            a.click();
            
            // Clear saved state after successful export
            clearSavedState();
            addMessage('system', 'âœ“ Results downloaded. Saved state cleared.');
        }
        
        function addMessage(role, content) {
            const container = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            
            const label = document.createElement('div');
            label.className = 'message-label';
            label.textContent = role === 'compass' ? 'COMPASS' : role === 'user' ? 'YOU' : 'SYSTEM';
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.textContent = content;
            
            messageDiv.appendChild(label);
            messageDiv.appendChild(contentDiv);
            container.appendChild(messageDiv);
            
            container.scrollTop = container.scrollHeight;
        }
        
        function updateStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
        }
        
        function enableInput() {
            document.getElementById('userInput').disabled = false;
            document.getElementById('sendBtn').disabled = false;
            document.getElementById('completeBtn').disabled = false;
            document.getElementById('saveBtn').disabled = false;
            document.getElementById('saveBtn').classList.remove('hidden');
            document.getElementById('saveStatus').classList.remove('hidden');
            document.getElementById('userInput').focus();
        }
        
        function disableInput() {
            document.getElementById('userInput').disabled = true;
            document.getElementById('sendBtn').disabled = true;
            document.getElementById('completeBtn').disabled = true;
        }
        
        // Enter key to send
        document.getElementById('userInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !this.disabled) {
                sendMessage();
            }
        });
    </script>
</body>
</html>
