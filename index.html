<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COMPASS - Stage 1 Process Interview</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <!-- API Key Modal -->
    <div id="apiKeyModal" class="fixed inset-0 bg-black/80 flex items-center justify-center z-50">
        <div class="bg-slate-900 border border-slate-700 rounded-2xl p-8 max-w-md w-full mx-4">
            <div class="flex items-center gap-3 mb-6">
                <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-amber-500 to-amber-700 flex items-center justify-center">
                    <span class="text-2xl">ðŸ§­</span>
                </div>
                <div>
                    <h1 class="text-xl font-semibold text-amber-400">COMPASS</h1>
                    <p class="text-sm text-slate-400">Stage 1: Process Interview</p>
                </div>
            </div>
            <p class="text-slate-300 mb-4">Enter your Anthropic API key to begin the interview.</p>
            <input 
                type="password" 
                id="apiKeyInput" 
                placeholder="sk-ant-..." 
                class="w-full bg-slate-800 border border-slate-600 rounded-lg px-4 py-3 text-slate-100 placeholder-slate-500 focus:outline-none focus:border-amber-500 mb-4"
            />
            <p class="text-xs text-slate-500 mb-4">Your key is stored only in this browser session and never sent to our servers.</p>
            <button 
                onclick="startInterview()" 
                class="w-full py-3 bg-amber-600 hover:bg-amber-500 rounded-lg font-medium text-white transition-colors"
            >
                Start Interview
            </button>
        </div>
    </div>

    <script>
        function startInterview() {
            const apiKey = document.getElementById('apiKeyInput').value.trim();
            if (!apiKey) {
                alert('Please enter your API key');
                return;
            }
            window.ANTHROPIC_API_KEY = apiKey;
            document.getElementById('apiKeyModal').style.display = 'none';
            loadApp();
        }

        function loadApp() {
            // Load the React component
            const script = document.createElement('script');
            script.type = 'text/babel';
            script.src = 'compass-interview.jsx';
            document.body.appendChild(script);
            
            // Render after script loads
            setTimeout(() => {
                const root = ReactDOM.createRoot(document.getElementById('root'));
                root.render(React.createElement(COMPASSInterview));
            }, 1000);
        }

        // Allow Enter key to submit
        document.getElementById('apiKeyInput').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') startInterview();
        });
    </script>

    <script type="text/babel" data-type="module">
        // COMPASS Stage 1: Process Interview
        const SYSTEM_PROMPT = `You are COMPASS, an AI process analyst conducting a Stage 1 Process Interview.

YOUR GOAL: Extract the high-level structure of a business process:
- MILESTONES: Major phases/stages of the process (typically 4-8)
- JOBS: Work areas within each milestone (typically 2-5 per milestone)

INTERVIEW APPROACH:
1. Start with a broad question about the process from start to finish
2. Listen for milestone boundaries (handoffs, decisions, phase changes)
3. Probe for jobs within each milestone
4. Confirm understanding before moving on
5. Keep questions focused and one at a time

UNIVERSAL PROCESS GRAMMAR PRINCIPLES:
- Completeness: Every process has beginning, middle, end
- Hierarchy: Pathway â†’ Milestone â†’ Job â†’ Task â†’ Step
- Conditionality: Branches based on variables
- Exception Handling: What happens when things go wrong
- Actor Assignment: Who performs each action
- Nomenclature: Consistent naming

RESPONSE FORMAT:
Always respond with JSON in this exact format:
{
  "message": "Your conversational response to the SME",
  "extracted": {
    "milestones": [
      {
        "name": "Milestone Name",
        "jobs": ["Job 1", "Job 2"]
      }
    ],
    "conditionalVariables": ["Variable 1", "Variable 2"],
    "actors": ["Actor 1", "Actor 2"]
  },
  "phase": "discovery|confirmation|complete",
  "completeness": 0.0 to 1.0
}

INTERVIEWING STYLE:
- Warm but professional
- One question at a time
- Acknowledge what you heard before asking more
- Use the SME's terminology
- Don't overwhelm with jargon
- Guide gently toward structure without forcing it`;

        const INITIAL_MESSAGE = {
            role: 'assistant',
            content: JSON.stringify({
                message: "Hello! I'm COMPASS, and I'll be helping you document a business process today.\n\nMy goal is to understand the high-level structure first â€” the major phases and work areas â€” before we dive into details.\n\nLet's start simple: **What process would you like to document today?** Just give me the name or a brief description.",
                extracted: { milestones: [], conditionalVariables: [], actors: [] },
                phase: 'discovery',
                completeness: 0
            })
        };

        function COMPASSInterview() {
            const [messages, setMessages] = React.useState([INITIAL_MESSAGE]);
            const [input, setInput] = React.useState('');
            const [isLoading, setIsLoading] = React.useState(false);
            const [processName, setProcessName] = React.useState('');
            const [structure, setStructure] = React.useState({
                milestones: [],
                conditionalVariables: [],
                actors: []
            });
            const [completeness, setCompleteness] = React.useState(0);
            const [phase, setPhase] = React.useState('discovery');
            const messagesEndRef = React.useRef(null);
            const inputRef = React.useRef(null);

            const scrollToBottom = () => {
                messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
            };

            React.useEffect(() => {
                scrollToBottom();
            }, [messages]);

            const parseAssistantMessage = (content) => {
                try {
                    const parsed = JSON.parse(content);
                    return parsed;
                } catch {
                    return {
                        message: content,
                        extracted: { milestones: [], conditionalVariables: [], actors: [] },
                        phase: 'discovery',
                        completeness: 0
                    };
                }
            };

            const mergeStructure = (prev, newExtracted) => {
                if (!newExtracted) return prev;
                
                const existingMilestoneNames = prev.milestones.map(m => m.name);
                const newMilestones = [...prev.milestones];
                
                for (const ms of newExtracted.milestones || []) {
                    const existingIdx = existingMilestoneNames.indexOf(ms.name);
                    if (existingIdx >= 0) {
                        // Merge jobs into existing milestone
                        const existingJobs = newMilestones[existingIdx].jobs || [];
                        const allJobs = [...new Set([...existingJobs, ...(ms.jobs || [])])];
                        newMilestones[existingIdx] = { ...newMilestones[existingIdx], jobs: allJobs };
                    } else {
                        newMilestones.push(ms);
                    }
                }
                
                return {
                    milestones: newMilestones,
                    conditionalVariables: [...new Set([...prev.conditionalVariables, ...(newExtracted.conditionalVariables || [])])],
                    actors: [...new Set([...prev.actors, ...(newExtracted.actors || [])])]
                };
            };

            const sendMessage = async () => {
                if (!input.trim() || isLoading) return;

                const userMessage = { role: 'user', content: input };
                const newMessages = [...messages, userMessage];
                setMessages(newMessages);
                setInput('');
                setIsLoading(true);

                // Capture process name from first response
                if (messages.length === 1) {
                    setProcessName(input.trim());
                }

                try {
                    // Build conversation for API
                    const apiMessages = newMessages.map(m => {
                        if (m.role === 'assistant') {
                            const parsed = parseAssistantMessage(m.content);
                            return { role: 'assistant', content: parsed.message };
                        }
                        return m;
                    });

                    const response = await fetch('https://api.anthropic.com/v1/messages', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-api-key': window.ANTHROPIC_API_KEY || '',
                            'anthropic-version': '2023-06-01',
                            'anthropic-dangerous-direct-browser-access': 'true'
                        },
                        body: JSON.stringify({
                            model: 'claude-sonnet-4-20250514',
                            max_tokens: 1024,
                            system: SYSTEM_PROMPT + `\n\nCurrent extracted structure:\n${JSON.stringify(structure, null, 2)}\n\nProcess being documented: ${processName || input.trim()}`,
                            messages: apiMessages.slice(1)
                        })
                    });

                    const data = await response.json();
                    
                    if (data.content && data.content[0]) {
                        const assistantContent = data.content[0].text;
                        const parsed = parseAssistantMessage(assistantContent);
                        
                        // Merge new extractions
                        if (parsed.extracted) {
                            setStructure(prev => mergeStructure(prev, parsed.extracted));
                        }
                        
                        if (parsed.completeness !== undefined) {
                            setCompleteness(parsed.completeness);
                        }
                        
                        if (parsed.phase) {
                            setPhase(parsed.phase);
                        }

                        setMessages([...newMessages, { role: 'assistant', content: assistantContent }]);
                    } else if (data.error) {
                        throw new Error(data.error.message || 'API error');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    setMessages([...newMessages, { 
                        role: 'assistant', 
                        content: JSON.stringify({
                            message: `I encountered an error: ${error.message}. Please check your API key and try again.`,
                            extracted: { milestones: [], conditionalVariables: [], actors: [] },
                            phase: 'discovery',
                            completeness: completeness
                        })
                    }]);
                }

                setIsLoading(false);
                inputRef.current?.focus();
            };

            const handleKeyDown = (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            };

            const exportStructure = () => {
                const exportData = {
                    processName,
                    interviewDate: new Date().toISOString(),
                    stage: 'Stage 1 - Process Interview',
                    structure,
                    completeness,
                    transcript: messages.map(m => ({
                        role: m.role,
                        content: m.role === 'assistant' ? parseAssistantMessage(m.content).message : m.content
                    }))
                };
                
                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `COMPASS_${(processName || 'Process').replace(/\s+/g, '_')}_Stage1.json`;
                a.click();
            };

            return (
                <div className="min-h-screen bg-slate-950 text-slate-100 flex">
                    {/* Left Panel - Conversation */}
                    <div className="flex-1 flex flex-col max-w-3xl">
                        {/* Header */}
                        <header className="p-6 border-b border-amber-900/30">
                            <div className="flex items-center gap-3">
                                <div className="w-10 h-10 rounded-lg bg-gradient-to-br from-amber-500 to-amber-700 flex items-center justify-center">
                                    <span className="text-xl">ðŸ§­</span>
                                </div>
                                <div>
                                    <h1 className="text-xl font-semibold text-amber-400">COMPASS</h1>
                                    <p className="text-sm text-slate-400">Stage 1: Process Interview</p>
                                </div>
                            </div>
                            {processName && (
                                <div className="mt-3 px-3 py-1.5 bg-slate-900 rounded-lg inline-block">
                                    <span className="text-slate-500 text-sm">Documenting:</span>
                                    <span className="text-amber-400 text-sm ml-2 font-medium">{processName}</span>
                                </div>
                            )}
                        </header>

                        {/* Messages */}
                        <div className="flex-1 overflow-y-auto p-6 space-y-4">
                            {messages.map((msg, idx) => {
                                const isAssistant = msg.role === 'assistant';
                                const content = isAssistant ? parseAssistantMessage(msg.content).message : msg.content;
                                
                                return (
                                    <div key={idx} className={`flex ${isAssistant ? 'justify-start' : 'justify-end'}`}>
                                        <div className={`max-w-[85%] rounded-2xl px-4 py-3 ${
                                            isAssistant 
                                                ? 'bg-slate-800/80 border border-slate-700/50' 
                                                : 'bg-amber-600/90 text-white'
                                        }`}>
                                            <p className="whitespace-pre-wrap text-[15px] leading-relaxed">{content}</p>
                                        </div>
                                    </div>
                                );
                            })}
                            {isLoading && (
                                <div className="flex justify-start">
                                    <div className="bg-slate-800/80 border border-slate-700/50 rounded-2xl px-4 py-3">
                                        <div className="flex gap-1">
                                            <span className="w-2 h-2 bg-amber-500 rounded-full animate-bounce" style={{animationDelay: '0ms'}}></span>
                                            <span className="w-2 h-2 bg-amber-500 rounded-full animate-bounce" style={{animationDelay: '150ms'}}></span>
                                            <span className="w-2 h-2 bg-amber-500 rounded-full animate-bounce" style={{animationDelay: '300ms'}}></span>
                                        </div>
                                    </div>
                                </div>
                            )}
                            <div ref={messagesEndRef} />
                        </div>

                        {/* Input */}
                        <div className="p-4 border-t border-slate-800">
                            <div className="flex gap-3">
                                <textarea
                                    ref={inputRef}
                                    value={input}
                                    onChange={(e) => setInput(e.target.value)}
                                    onKeyDown={handleKeyDown}
                                    placeholder="Describe your process..."
                                    className="flex-1 bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-slate-100 placeholder-slate-500 focus:outline-none focus:border-amber-500/50 resize-none"
                                    rows={2}
                                    disabled={isLoading}
                                />
                                <button
                                    onClick={sendMessage}
                                    disabled={isLoading || !input.trim()}
                                    className="px-6 bg-amber-600 hover:bg-amber-500 disabled:bg-slate-700 disabled:cursor-not-allowed rounded-xl font-medium transition-colors"
                                >
                                    Send
                                </button>
                            </div>
                        </div>
                    </div>

                    {/* Right Panel - Structure */}
                    <div className="w-80 bg-slate-900/50 border-l border-slate-800 p-6 overflow-y-auto hidden lg:block">
                        <div className="space-y-6">
                            {/* Progress */}
                            <div>
                                <div className="flex justify-between items-center mb-2">
                                    <span className="text-sm text-slate-400">Interview Progress</span>
                                    <span className="text-sm text-amber-400">{Math.round(completeness * 100)}%</span>
                                </div>
                                <div className="h-2 bg-slate-800 rounded-full overflow-hidden">
                                    <div 
                                        className="h-full bg-gradient-to-r from-amber-600 to-amber-400 transition-all duration-500"
                                        style={{ width: `${completeness * 100}%` }}
                                    />
                                </div>
                                <p className="text-xs text-slate-500 mt-1 capitalize">Phase: {phase}</p>
                            </div>

                            {/* Milestones */}
                            <div>
                                <h3 className="text-sm font-medium text-slate-300 mb-3 flex items-center gap-2">
                                    <span className="w-5 h-5 rounded bg-amber-600/20 text-amber-400 flex items-center justify-center text-xs">M</span>
                                    Milestones ({structure.milestones.length})
                                </h3>
                                {structure.milestones.length === 0 ? (
                                    <p className="text-sm text-slate-500 italic">None identified yet...</p>
                                ) : (
                                    <div className="space-y-2">
                                        {structure.milestones.map((ms, idx) => (
                                            <div key={idx} className="bg-slate-800/50 rounded-lg p-3">
                                                <div className="flex items-center gap-2">
                                                    <span className="text-amber-400 text-xs font-mono">{idx + 1}</span>
                                                    <span className="text-sm font-medium">{ms.name}</span>
                                                </div>
                                                {ms.jobs && ms.jobs.length > 0 && (
                                                    <div className="mt-2 pl-4 border-l border-slate-700 space-y-1">
                                                        {ms.jobs.map((job, jIdx) => (
                                                            <p key={jIdx} className="text-xs text-slate-400">â€¢ {job}</p>
                                                        ))}
                                                    </div>
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>

                            {/* Conditional Variables */}
                            {structure.conditionalVariables.length > 0 && (
                                <div>
                                    <h3 className="text-sm font-medium text-slate-300 mb-3 flex items-center gap-2">
                                        <span className="w-5 h-5 rounded bg-blue-600/20 text-blue-400 flex items-center justify-center text-xs">?</span>
                                        Conditional Variables
                                    </h3>
                                    <div className="flex flex-wrap gap-2">
                                        {structure.conditionalVariables.map((cv, idx) => (
                                            <span key={idx} className="px-2 py-1 bg-blue-900/30 text-blue-300 rounded text-xs">
                                                {cv}
                                            </span>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {/* Actors */}
                            {structure.actors.length > 0 && (
                                <div>
                                    <h3 className="text-sm font-medium text-slate-300 mb-3 flex items-center gap-2">
                                        <span className="w-5 h-5 rounded bg-green-600/20 text-green-400 flex items-center justify-center text-xs">A</span>
                                        Actors
                                    </h3>
                                    <div className="flex flex-wrap gap-2">
                                        {structure.actors.map((actor, idx) => (
                                            <span key={idx} className="px-2 py-1 bg-green-900/30 text-green-300 rounded text-xs">
                                                {actor}
                                            </span>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {/* Export Button */}
                            {structure.milestones.length > 0 && (
                                <button
                                    onClick={exportStructure}
                                    className="w-full py-2 bg-slate-800 hover:bg-slate-700 border border-slate-700 rounded-lg text-sm text-slate-300 transition-colors"
                                >
                                    Export Structure (JSON)
                                </button>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        // Mount the app
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<COMPASSInterview />);
    </script>
</body>
</html>
